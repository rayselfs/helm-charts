name: Release Helm Chart

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  detect-charts:
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.detect-charts.outputs.charts }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Detect charts to release
        id: detect-charts # This ID is important for outputs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CHARTS_TO_RELEASE=()
          
          # 掃描 charts/ 目錄下的所有 chart
          for chart_dir in charts/*/; do
            # 移除尾部的斜線，獲取 chart 名稱
            chart_name=$(basename "$chart_dir")
            chart_path="charts/$chart_name"
            
            # 檢查是否為有效的 chart 目錄（包含 Chart.yaml）
            if [ ! -f "$chart_path/Chart.yaml" ]; then
              echo "Skipping $chart_path: Chart.yaml not found"
              continue
            fi
            
            # 讀取 Chart.yaml 的 name 和 version
            chart_name_from_yaml=$(yq eval '.name' "$chart_path/Chart.yaml")
            chart_version=$(yq eval '.version' "$chart_path/Chart.yaml")
            
            if [ -z "$chart_name_from_yaml" ] || [ -z "$chart_version" ]; then
              echo "Skipping $chart_path: Missing name or version in Chart.yaml"
              continue
            fi
            
            # 構建 tag 名稱
            tag="${chart_name_from_yaml}-${chart_version}"
            
            # 檢查 GitHub Release 是否已存在
            if gh release view "$tag" >/dev/null 2>&1; then
              echo "Skipping $chart_name: Release $tag already exists"
              continue
            fi
            
            # 加入發布列表
            CHARTS_TO_RELEASE+=("$chart_name")
            echo "Will release: $chart_name (version: $chart_version, tag: $tag)"
          done
          
          # 將 chart 列表轉換為 JSON 陣列格式
          if [ ${#CHARTS_TO_RELEASE[@]} -eq 0 ]; then
            echo "No charts to release"
            echo "charts=[]" >> $GITHUB_OUTPUT
          else
            CHARTS_JSON=$(printf '%s\n' "${CHARTS_TO_RELEASE[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "charts=$CHARTS_JSON" >> $GITHUB_OUTPUT
            echo "Charts to release:"
            printf '%s\n' "${CHARTS_TO_RELEASE[@]}"
          fi

      # [Optimization] Removed 'Set charts output' step since 'detect-charts' step already outputs the result.

  release:
    needs: detect-charts
    if: needs.detect-charts.outputs.charts != '[]'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required permission to create releases
    
    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-charts.outputs.charts) }}
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate chart directory
        run: |
          CHART_NAME="${{ matrix.chart }}"
          CHART_PATH="charts/$CHART_NAME"
          if [ ! -d "$CHART_PATH" ]; then
            echo "Error: Chart directory '$CHART_PATH' does not exist"
            exit 1
          fi
          if [ ! -f "$CHART_PATH/Chart.yaml" ]; then
            echo "Error: Chart.yaml not found in '$CHART_PATH' directory"
            exit 1
          fi
          echo "Chart directory validated: $CHART_PATH"

      - name: Get chart metadata and version
        id: chart_metadata
        run: |
          CHART_NAME="${{ matrix.chart }}"
          CHART_PATH="charts/$CHART_NAME"
          cd "$CHART_PATH"
          
          # 從 Chart.yaml 讀取所有資訊
          CHART_NAME_FROM_YAML=$(yq eval '.name' Chart.yaml)
          CHART_VERSION=$(yq eval '.version' Chart.yaml)
          CHART_DESCRIPTION=$(yq eval '.description // "Helm Chart"' Chart.yaml)
          APP_VERSION=$(yq eval '.appVersion // ""' Chart.yaml)
          
          if [ -z "$CHART_VERSION" ]; then
            echo "Error: Version not found in Chart.yaml"
            exit 1
          fi
          
          echo "chart_name_from_yaml=$CHART_NAME_FROM_YAML" >> $GITHUB_OUTPUT
          echo "chart_version=$CHART_VERSION" >> $GITHUB_OUTPUT
          echo "chart_description=$CHART_DESCRIPTION" >> $GITHUB_OUTPUT
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "tag=${CHART_NAME_FROM_YAML}-${CHART_VERSION}" >> $GITHUB_OUTPUT
          
          echo "Chart: $CHART_NAME_FROM_YAML"
          echo "Version: $CHART_VERSION"
          echo "App Version: $APP_VERSION"
          
          # 驗證目錄名稱和 Chart.yaml 中的名稱是否一致
          if [ "$CHART_NAME_FROM_YAML" != "$CHART_NAME" ]; then
            echo "Warning: Directory name '$CHART_NAME' does not match chart name in Chart.yaml '$CHART_NAME_FROM_YAML'"
          fi

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt-get update && sudo apt-get install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt-get update \
          && sudo apt-get install gh -y

      - name: Check if release already exists
        id: check_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.chart_metadata.outputs.tag }}"
          # 檢查 GitHub Release 是否已存在
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists, skipping release"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Release $TAG does not exist, will create new release"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Lint chart
        if: steps.check_release.outputs.exists != 'true'
        run: |
          CHART_NAME="${{ matrix.chart }}"
          CHART_PATH="charts/$CHART_NAME"
          cd "$CHART_PATH"
          helm lint .

      - name: Package chart
        if: steps.check_release.outputs.exists != 'true'
        id: package
        run: |
          # Get directory name from matrix
          CHART_DIR_NAME="${{ matrix.chart }}"
          CHART_PATH="charts/$CHART_DIR_NAME"
          
          # Get 'name' from Chart.yaml via 'chart_metadata' step
          CHART_NAME_FROM_YAML="${{ steps.chart_metadata.outputs.chart_name_from_yaml }}"
          
          mkdir -p packages
          cd "$CHART_PATH"
          
          # helm package uses the 'name' from Chart.yaml to name the file
          helm package . --destination ../../packages
          
          # Use $CHART_NAME_FROM_YAML (from Chart.yaml) to find the correct file
          CHART_FILE=$(ls ../../packages/${CHART_NAME_FROM_YAML}-*.tgz | head -1)
          
          # Add error check to ensure file is found
          if [ -z "$CHART_FILE" ]; then
            echo "Error: Could not find packaged chart file!"
            echo "Looked for: ../../packages/${CHART_NAME_FROM_YAML}-*.tgz"
            echo "Files in packages dir:"
            ls -l ../../packages/
            exit 1
          fi
          
          echo "chart_file=$CHART_FILE" >> $GITHUB_OUTPUT
          echo "chart_name=$(basename $CHART_FILE)" >> $GITHUB_OUTPUT
          echo "Chart packaged: $CHART_FILE"

      - name: Create Release
        if: steps.check_release.outputs.exists != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.chart_metadata.outputs.tag }}
          name: ${{ steps.chart_metadata.outputs.chart_name_from_yaml }} ${{ steps.chart_metadata.outputs.chart_version }}
          body: |
            Helm Chart Release: **${{ steps.chart_metadata.outputs.chart_name_from_yaml }}**
            
            **Chart Version:** ${{ steps.chart_metadata.outputs.chart_version }}
            ${{ steps.chart_metadata.outputs.app_version && format('**App Version:** {0}', steps.chart_metadata.outputs.app_version) || '' }}
            
            **Description:** ${{ steps.chart_metadata.outputs.chart_description }}
            
            ## Installation
            
            ```bash
            helm repo add <your-repo-name> <your-repo-url>
            helm install ${{ steps.chart_metadata.outputs.chart_name_from_yaml }} <your-repo-name>/${{ steps.chart_metadata.outputs.chart_name_from_yaml }}
            ```
          files: |
            ${{ steps.package.outputs.chart_file }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip release message
        if: steps.check_release.outputs.exists == 'true'
        run: |
          echo "Release ${{ steps.chart_metadata.outputs.tag }} already exists, skipping..."